.TH asm 1 "2016-10-20" "asmdisks" "ASMdisks User Manual"
.SH NAME
asm \- tool for managing Oracle ASM devices via udev(7)
.SH SYNOPSIS
.B asm [-n] [-t] <command> [args]
.SH DESCRIPTION
.B asm 
is a replacement for the
.B oracleasm
command provided via Oracle ASMlib. It attempts to provide similar functionality using a simple script
and Linux UDEV rather than tweaking the kernel with an add-on kernel module, 
complex configuration and binary files.

It will create block devices from disks, partitions or mapper devices, 
under /dev/oracleasm/ (default) for use with Oracle and changes permissions to 
grid:asmdba to allow Oracle ASM read/write access to those disks (only). 
Mapper devices can be multipath devices, LVM logical volumes, or any other
block device managed by Linux device-mapper.

The administration of those files is done through the
.I /etc/asmtab
configuration file, which holds the asmdisks volume name, volume type, 
and the identifier, to provide persistent naming across reboots
and reconfiguration. You may manually edit this file if so needed. The 
.B UDEV
configuration in /etc/udev/rules.d/ is built from the definitions in asmtab.
.P
This tool is completely out-of-band, which means it is only used for generating
and activating the udev rules file and does nothing until an administrator runs
the tool. You may even remove asmdisks and the configuration will still keep working.
.SH OPTIONS
.TP 5
rescan
lets the kernel probe for new SCSI devices (after hot-adding disks)
.TP 5 
createdisk <label> <block device>
adds a disk as /dev/oracleasm/<label>
If you want the disk to appear under another path (such as /dev/iorate) then use 
the relative path as label (i.e. asm createdisk iorate/vol1 <id>)
.br
The block device can be a raw disk (i.e. /dev/sdX), a previously created (empty) 
disk partition (/dev/sdX1), or a device-mapper block device, to be specified as 
any mapper device that points to the correct /dev/dm-X device, 
such as LVM logical volumes (i.e. /dev/myvg/lvol1), multipath devices (/dev/mapper/mpathX) 
etc. "asm" will attempt to figure out the type of device and specify the correct ID in asmtab.
.TP 5 
deletedisk <label>
deletes the disk from /dev/<diskstring>/. It will not be completely removed but re-appear 
as /dev/sdX or /dev/dm-X etc. Be careful, if the disk is still in use it could 
result in I/O errors and even dataloss.
.TP 5
scandisks
processes any (manual) changes to asmtab (run it after createdisk/deletedisk to 
activate your changes). It's called automatically after createdisk/deletedisk actions.
.TP 5
disks|listdisks
shows all disks including unused /dev/sdXX disks available for asm
also shows SCSI addresses (handy for figuring out which VMDK / iSCSI / etc volume is used)
.TP 5
list
.br
show asmdisks configured disks only
.TP 5
multi
.br
show multipath devices
.TP 5
import
Imports all volumes from /dev/sd* that are labeled as ASMdisk (i.e. they have an Oracle ASM disk
signature created by another host (cloning) or another node (RAC). It simply imports volumes
as vol01, vol02, etc. as ASM does not care what the Linux device name looks like anyway.
.SH SCSI UUID
The scsi identifier is retrieved via the
.B scsi_id(8)
command and depends on the OS and hardware layer to provide this. 
The VMware default (all products) is to have this ID disabled. It must be re-enabled with
.P
.B disk.EnableUUID = \(dqTRUE\(dq
.P
in the VM's VMX configuration file.
This tool will not work without this setting.  You may verify if that works using the command
.br
.B scsi_id --whitelisted /dev/sda
.br
or running "asm" without options (it will complain if /dev/sda does not show a SCSI identifier).
.SH DISKSTRINGS
The default diskstring under which new volumes are placed is /dev/oracleasm/ with 
ownership grid:asmdba and mode 0660.
.br
You may want to configure volumes elsewhere and with different permissions. If you specify a 
relative path as volume name then the volume will be configured under /dev/<path>/name, 
for example "iorate/vol1" will appear as /dev/iorate/vol1.
The permissions will be the default (grid:asmdba) unless an entry for the new diskstring 
is defined in asmtab (needs to be done manually). At initial creation, "asm" defines 
one special case (in asmtab) for iorate:
.br
PATH=iorate:root:iops:0660
.br
This means if you create volumes as iorate/<volname> they will have permissions root:iops @ mode 0660.
This allows the IORate tool to run under userid "iorate" having group membership "iops" with access
to those devices - without giving the user full access to all disks (such as by making it 
a member of the "disk" group). This prevents IORate to accidentally overwrite OS or ASM 
devices (when using the iorate RPM package, that is). IORate will only have direct access 
to volumes under /dev/iorate.
ASM will fall back to grid:asmdba if the specified user/group does not exist.
Another purpose for having an additional diskstring is if you want to run more 
than one Oracle ASM instance - each can have it's own diskstring and permissions.
The default grid:asmdba owner/group can be altered by setting 
.br
PATH=oracleasm:user:group:mode in the asmtab file.

.SH ASMTAB file format
Define all non-default diskstrings as
.br
PATH=<diskstring>:<owner>:<group>:<mode>
.br
Non-defined diskstrings will have default ownerships/modes.
.br
For every volume to be defined, register one entry in asmtab as
.br
<diskstring/volumename> <type> <id>
.br
diskstring may be omitted (defaults to "oracleasm"). Type is currently either "scsi" or "mapper".
.br
id is either a scsi_identifier (such as SCSI device "36000c29f825cd85b5fcc70a1aadebf0c" or 
iSCSI id "1IET_00010001") or a similar identifier appended with :<partnum>, 
such as "36000c29f825cd85b5fcc70a1aadebf0c:2" indicating the 2nd partition on that 
SCSI disk, or a name as it appears under /dev/mapper/ such as /dev/mapper/myvg-vol1.
.br
Normally you should not have to edit asmtab manually, however in some cases it may become handy.
.SH SUPPORTED DISK TYPES
asmdisks currently supports the following block device types:
.P
- Plain SCSI disk (/dev/sd*)
.br
- Linux Multipath (/etc/multipath/*, multipath -ll)
.br
- Linux Logical Volumes (/dev/vgname/lvname) 
.br
- EMC Powerpath (/dev/power*)
.br
- EMC DSSD (/dev/dssd*)
.br

.SH RAC and Clusterware
Be aware that Oracle RAC requires shared devices as ASM volumes. This means running 
RAC with anything else than full SCSI disks or SCSI disk partitions will not work.
.SH FILES
/etc/asmtab
.br
/dev/oracleasm/
.br
/dev/iorate/
.br
/etc/udev/rules.d/99-asm.rules
.br
/etc/scsi_id.config
.SH RAW SCSI disks or disk partitions
Many administrators prefer to create a primary partition first on each disk, 
then use that for ASM (this is the standard way of using disks with Oracle ASMLib). 
My preference is to hand full disks (not partitioned) to ASM. By using "asm" 
the risk of a rookie administrator creating filesystems or anything else on that disk 
is virtually eliminated, because the disk device is removed from /dev/sdXX, 
and reappears as /dev/oracleasm/volXX. An admin who would still create a filesystem on 
such a device should be sent back to basic UNIX administration training. 
Using full disks eliminates the need for disk alignment and some extra administration steps.
.P
Note that with Enterprise Linux 7 this feature of udev no longer works and the only option
is to add symlinks to devices in /dev/ so this is now the standard behaviour of asmdisks.

.SH BASH COMPLETION
If you have the package bash-completion installed, you may use TAB to show possible
command options or auto-complete things like disk and volume names.
.SH USE IN SCRIPTS
If you want to parse the output of "asm" (list/disks) for usage in scripts, you can use the "-t"
option so that the output is TAB separated instead of column formatted.
.br
In future versions, the columns and output order may change.
.SH BOOT DISK PROTECTION
asmdisks attempts to detect which disk is used as bootdisk and prevent messing with this disk directly.
In some cases the detection fails. You may add the bootdisk to /etc/asmtab manually.
.SH KNOWN ISSUES
\(em Modifying the UDEV config requires running "udevadm trigger" which in turn triggers network reconfiguration.
A known issue when using DHCP is that the network scripts attempt to start a 2nd dhclient - which fails and
results in errors in the syslog. You can safely ignore these.
.br
\(em Enabling or disabling Linux Multipath may require a reboot to prevent strange asmdisks behaviour.
.SH BUGS
Likely. Currently "asm" does not do a lot of validation checking so in classic UNIX style, it offers
many ways to mess up. Especially via directly editing asmtab. You have been warned.
.br
That said, asm is "out of band", in other words it is not required for correct presentation of
ASM devices. You could deinstall asmdisks, reboot and the ASM volumes would still be there (because of
the 99-asm.rules UDEV file). In the end, "asm" only manages this file and you may verify at any time
if the contents are correct or make backup copies of the file at any time.
.br 
Note that to avoid potential problems with boot devices, /dev/sda is excluded from 
any manipulation (I learned the hard way ;)
.br
So even if you mess up, you should be able to boot and fix problems by removing/restoring 
99-asm.rules followed by "udevadm trigger" to reset udev. 
Then fix issues in asmtab and retry "asm scandisks".
.P
EMC Powerpath has not yet been fully tested with asm, but this would 
only be required for physically deployed hosts. Likewise for non-standard SCSI devices such as
paravirtualized devices, or any other disk type that shows up different from what is expected.
.br
Roughly speaking, any device that shows up as /dev/sdXX in Linux (i.e. it is an "sd" device type) should work. 
If you want support for another non-standard device type, let me know and I will see if it's possible to add support.
.SH SEE ALSO
wipedisk(1), asmstat(1), udev(7), udevadm(8), scsi_id(8)
.SH AUTHOR
Compiled by Bart Sjerps - contact me via my blog "Dirty Cache" - \fIhttp://bartsjerps.wordpress.com\fR
.br
If you have suggestions for improvements in this tool, please send them
along via the above address.
.SH COPYRIGHT
This software is Open Source and may be distributed "as is", modified, reproduced
and passed to others under the GPLv3 license - \fIhttp://www.gnu.org/licenses/gpl-3.0.txt\fR
.SH DISCLAIMER
This software is provided "as is" and because it is mostly based
on CentOS linux, it follows the licensing and warranty guidelines 
of the GPL. In normal language that means I will not be held 
responsible for any problems you may encounter with this software.
